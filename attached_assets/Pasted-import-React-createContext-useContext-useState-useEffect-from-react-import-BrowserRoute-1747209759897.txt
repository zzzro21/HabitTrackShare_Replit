import React, { createContext, useContext, useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route, useNavigate } from 'react-router-dom';

/**
 * AuthContext: ë¡œê·¸ì¸ ìƒíƒœ ë° ì‚¬ìš©ì ì •ë³´, API Key/Notion Token ê´€ë¦¬
 */
const AuthContext = createContext(null);

export const useAuth = () => {
  return useContext(AuthContext);
};

/**
 * 8ëª… ê³ ì • ì‚¬ìš©ì ëª©ë¡
 */
const defaultUsers = [
  { id: 1, name: 'ê³½ì™„ì‹ ', username: 'user1', avatar: 'ğŸ‘¨â€ğŸ’¼' },
  { id: 2, name: 'ìœ ì€ì˜¥', username: 'user2', avatar: 'ğŸ‘©â€ğŸ’¼' },
  { id: 3, name: 'ì´ê²½í¬', username: 'user3', avatar: 'ğŸ‘©â€ğŸ¦°' },
  { id: 4, name: 'ì„ìš©ë…€', username: 'user4', avatar: 'ğŸ‘©â€ğŸ¦³' },
  { id: 5, name: 'ë°•í˜œê²½', username: 'user5', avatar: 'ğŸ‘±â€â™€ï¸' },
  { id: 6, name: 'ê¹€ìœ ë‚˜', username: 'user6', avatar: 'ğŸ‘§' },
  { id: 7, name: 'ìµœì§€í˜œ', username: 'user7', avatar: 'ğŸ‘©â€ğŸ¦±' },
  { id: 8, name: 'ê¹€ë¯¸í¬', username: 'user8', avatar: 'ğŸ‘§' }
];

/**
 * AuthProvider: ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬
 */
export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [keys, setKeys] = useState({ apiKey: '', notionToken: '' });

  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
  useEffect(() => {
    const stored = localStorage.getItem('authUser');
    if (stored) setUser(JSON.parse(stored));
    const savedKeys = localStorage.getItem('authKeys');
    if (savedKeys) setKeys(JSON.parse(savedKeys));
  }, []);

  // ë¡œê·¸ì¸ í•¨ìˆ˜
  const login = (u) => {
    localStorage.setItem('authUser', JSON.stringify(u));
    setUser(u);
  };

  // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
  const logout = () => {
    localStorage.removeItem('authUser');
    setUser(null);
  };

  // API Key/Notion Token ì„¤ì •
  const saveKeys = (apiKey, notionToken) => {
    const k = { apiKey, notionToken };
    localStorage.setItem('authKeys', JSON.stringify(k));
    setKeys(k);
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, keys, saveKeys, defaultUsers }}>
      {children}
    </AuthContext.Provider>
  );
};

/**
 * EmergencyLogin: ê³ ì • ì‚¬ìš©ì 8ëª…ìœ¼ë¡œ ë¡œê·¸ì¸
 */
const EmergencyLogin = () => {
  const { defaultUsers, login } = useAuth();
  const navigate = useNavigate();

  const handleLogin = (u) => {
    login(u);
    navigate('/main');
  };

  return (
    <div style={{ padding: 20, textAlign: 'center' }}>
      <h1>ê¸´ê¸‰ ë¡œê·¸ì¸</h1>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 10 }}>
        {defaultUsers.map(u => (
          <button key={u.id}
                  onClick={() => handleLogin(u)}
                  style={{ padding: 15, borderRadius: 8, border: '1px solid #ccc' }}>
            <div style={{ fontSize: 32 }}>{u.avatar}</div>
            <div>{u.name}</div>
            <div style={{ fontSize: 12, color: '#666' }}>{u.username}</div>
          </button>
        ))}
      </div>
    </div>
  );
};

/**
 * MainPage: ë¡œê·¸ì¸ í›„ ë³´ì—¬ì¤„ ë©”ì¸ í˜ì´ì§€
 */
const MainPage = () => {
  const { user, logout } = useAuth();
  return (
    <div style={{ padding: 20 }}>
      <h2>í™˜ì˜í•©ë‹ˆë‹¤, {user.name}ë‹˜!</h2>
      <button onClick={logout} style={{ marginTop: 20 }}>ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  );
};

/**
 * SettingsPage: API Key, Notion Token ì…ë ¥
 */
const SettingsPage = () => {
  const { keys, saveKeys } = useAuth();
  const [apiKey, setApiKey] = useState(keys.apiKey);
  const [notionToken, setNotionToken] = useState(keys.notionToken);

  const handleSave = () => saveKeys(apiKey, notionToken);

  return (
    <div style={{ padding: 20 }}>
      <h2>ì„¤ì •</h2>
      <div>
        <label>API Key</label>
        <input value={apiKey} onChange={e => setApiKey(e.target.value)} />
      </div>
      <div>
        <label>Notion Token</label>
        <input value={notionToken} onChange={e => setNotionToken(e.target.value)} />
      </div>
      <button onClick={handleSave} style={{ marginTop: 10 }}>ì €ì¥</button>
    </div>
  );
};

/**
 * App: ë¼ìš°íŒ… ë° ì „ì²´ êµ¬ì¡°
 */
export default function App() {
  return (
    <BrowserRouter>
      <AuthProvider>
        <Routes>
          <Route path="/login" element={<EmergencyLogin />} />
          <Route path="/main" element={<MainPage />} />
          <Route path="/settings" element={<SettingsPage />} />
          <Route path="/*" element={<EmergencyLogin />} />
        </Routes>
      </AuthProvider>
    </BrowserRouter>
  );
}
