import React, { createContext, useContext, useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route, useNavigate } from 'react-router-dom';

/**
 * AuthContext: ë¡œê·¸ì¸ ìƒíƒœ ë° ì‚¬ìš©ì ì •ë³´, API Key/Notion Token, ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬
 */
const AuthContext = createContext(null);
export const useAuth = () => useContext(AuthContext);

/**
 * 8ëª… ê³ ì • ì‚¬ìš©ì ëª©ë¡
 */
const defaultUsers = [
  { id: 1, name: 'ê³½ì™„ì‹ ', username: 'user1', avatar: 'ğŸ‘¨â€ğŸ’¼' },
  { id: 2, name: 'ìœ ì€ì˜¥', username: 'user2', avatar: 'ğŸ‘©â€ğŸ’¼' },
  { id: 3, name: 'ì´ê²½í¬', username: 'user3', avatar: 'ğŸ‘©â€ğŸ¦°' },
  { id: 4, name: 'ì„ìš©ë…€', username: 'user4', avatar: 'ğŸ‘©â€ğŸ¦³' },
  { id: 5, name: 'ë°•í˜œê²½', username: 'user5', avatar: 'ğŸ‘±â€â™€ï¸' },
  { id: 6, name: 'ê¹€ìœ ë‚˜', username: 'user6', avatar: 'ğŸ‘§' },
  { id: 7, name: 'ìµœì§€í˜œ', username: 'user7', avatar: 'ğŸ‘©â€ğŸ¦±' },
  { id: 8, name: 'ê¹€ë¯¸í¬', username: 'user8', avatar: 'ğŸ‘§' }
];

/**
 * AuthProvider: ë¡œê·¸ì¸/í‚¤/ë¹„ë°€ë²ˆí˜¸ ìƒíƒœ ê´€ë¦¬
 */
export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [keys, setKeys] = useState({ apiKey: '', notionToken: '' });
  const [passwords, setPasswords] = useState({});

  // ì´ˆê¸° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¡œë”©
  useEffect(() => {
    // ë¡œê·¸ì¸ ìƒíƒœ
    const storedUser = localStorage.getItem('authUser');
    if (storedUser) setUser(JSON.parse(storedUser));
    // í‚¤ ìƒíƒœ
    const storedKeys = localStorage.getItem('authKeys');
    if (storedKeys) setKeys(JSON.parse(storedKeys));
    // ë¹„ë°€ë²ˆí˜¸ ë§¤í•‘
    const storedPw = localStorage.getItem('authPasswords');
    if (storedPw) {
      setPasswords(JSON.parse(storedPw));
    } else {
      // ì´ˆê¸° ëª¨ë“  ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ password123
      const init = {};
      defaultUsers.forEach(u => { init[u.username] = 'password123'; });
      setPasswords(init);
      localStorage.setItem('authPasswords', JSON.stringify(init));
    }
  }, []);

  // ë¡œê·¸ì¸
  const login = (u, apiKey, notionToken) => {
    localStorage.setItem('authUser', JSON.stringify(u));
    localStorage.setItem('authKeys', JSON.stringify({ apiKey, notionToken }));
    setUser(u);
    setKeys({ apiKey, notionToken });
  };

  // ë¡œê·¸ì•„ì›ƒ
  const logout = () => {
    localStorage.removeItem('authUser');
    localStorage.removeItem('authKeys');
    setUser(null);
    setKeys({ apiKey: '', notionToken: '' });
  };

  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
  const changePassword = (username, newPassword) => {
    const updated = { ...passwords, [username]: newPassword };
    setPasswords(updated);
    localStorage.setItem('authPasswords', JSON.stringify(updated));
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, keys, passwords, changePassword, defaultUsers }}>
      {children}
    </AuthContext.Provider>
  );
};

/**
 * EmergencyLogin: ì‚¬ìš©ì ì„ íƒ + ë¹„ë°€ë²ˆí˜¸Â·API Key ì…ë ¥ í›„ ë¡œê·¸ì¸
 */
const EmergencyLogin = () => {
  const { defaultUsers, passwords, login } = useAuth();
  const [selected, setSelected] = useState(null);
  const [password, setPassword] = useState('');
  const [apiKey, setApiKey] = useState('');
  const [notionToken, setNotionToken] = useState('');
  const navigate = useNavigate();

  const handleLogin = () => {
    if (!selected || passwords[selected.username] !== password) {
      alert('ì‚¬ìš©ì ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
      return;
    }
    login(selected, apiKey.trim(), notionToken.trim());
    navigate('/main');
  };

  return (
    <div style={{ padding: 20, maxWidth: 400, margin: '0 auto' }}>
      <h1>ë³´ì•ˆ ë¡œê·¸ì¸</h1>
      <select
        style={{ width: '100%', padding: 10, marginBottom: 10 }}
        value={selected?.username || ''}
        onChange={e => setSelected(defaultUsers.find(u => u.username === e.target.value))}>
        <option value="" disabled>ì‚¬ìš©ì ì„ íƒ</option>
        {defaultUsers.map(u => (
          <option key={u.id} value={u.username}>{u.name}</option>
        ))}
      </select>
      <input
        type="password"
        placeholder="ë¹„ë°€ë²ˆí˜¸"
        value={password}
        onChange={e => setPassword(e.target.value)}
        style={{ width: '100%', padding: 10, marginBottom: 10 }}
      />
      <input
        type="text"
        placeholder="API Key (ì„ íƒ)"
        value={apiKey}
        onChange={e => setApiKey(e.target.value)}
        style={{ width: '100%', padding: 10, marginBottom: 10 }}
      />
      <input
        type="text"
        placeholder="Notion Token (ì„ íƒ)"
        value={notionToken}
        onChange={e => setNotionToken(e.target.value)}
        style={{ width: '100%', padding: 10, marginBottom: 20 }}
      />
      <button onClick={handleLogin} style={{ width: '100%', padding: 12, backgroundColor: '#2563eb', color: '#fff', border: 'none', borderRadius: 6 }}>
        ë¡œê·¸ì¸
      </button>
    </div>
  );
};

/**
 * MainPage: ë¡œê·¸ì¸ í›„ ë©”ì¸ í˜ì´ì§€
 * - AI ê¸°ëŠ¥ì€ apiKeyê°€ ìˆì„ ë•Œë§Œ í™œì„±í™”
 */
const MainPage = () => {
  const { user, keys, logout } = useAuth();
  return (
    <div style={{ padding: 20 }}>
      <h2>í™˜ì˜í•©ë‹ˆë‹¤, {user.name}ë‹˜!</h2>
      {keys.apiKey ? (
        <p>AI ë¹„ì„œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      ) : (
        <p>AI ë¹„ì„œ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ API Keyë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p>
      )}
      <button onClick={logout} style={{ marginTop: 20 }}>ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  );
};

/**
 * SettingsPage: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ & API Key/Notion Token ì¬ì„¤ì •
 */
const SettingsPage = () => {
  const { user, passwords, changePassword, keys, login } = useAuth();
  const [newPw, setNewPw] = useState('');
  const [apiKey, setApiKey] = useState(keys.apiKey);
  const [notionToken, setNotionToken] = useState(keys.notionToken);

  const handleSave = () => {
    if (newPw) {
      changePassword(user.username, newPw);
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    login(user, apiKey.trim(), notionToken.trim());
    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };

  return (
    <div style={{ padding: 20 }}>
      <h2>ì„¤ì •</h2>
      <div style={{ marginBottom: 10 }}>
        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input
          type="password"
          placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸"
          value={newPw}
          onChange={e => setNewPw(e.target.value)}
          style={{ width: '100%', padding: 8 }}
        />
      </div>
      <div style={{ marginBottom: 10 }}>
        <label>API Key</label>
        <input value={apiKey} onChange={e => setApiKey(e.target.value)} style={{ width: '100%', padding: 8 }} />
      </div>
      <div style={{ marginBottom: 20 }}>
        <label>Notion Token</label>
        <input value={notionToken} onChange={e => setNotionToken(e.target.value)} style={{ width: '100%', padding: 8 }} />
      </div>
      <button onClick={handleSave} style={{ padding: 10, backgroundColor: '#10b981', color: '#fff', border: 'none', borderRadius: 6 }}>
        ì €ì¥
      </button>
    </div>
  );
};

export default function App() {
  return (
    <BrowserRouter>
      <AuthProvider>
        <Routes>
          <Route path="/login" element={<EmergencyLogin />} />
          <Route path="/main" element={<MainPage />} />
          <Route path="/settings" element={<SettingsPage />} />
          <Route path="/*" element={<EmergencyLogin />} />
        </Routes>
      </AuthProvider>
    </BrowserRouter>
  );
}
